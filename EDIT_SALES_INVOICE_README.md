# تعديل صفحة فاتورة المبيعات - صفحة التعديل

## التحديثات المطبقة

### 1. تحويل الصفحة إلى صفحة تعديل/إنشاء
- تم إضافة منطق للتعرف على معاملات URL لتحديد وضع التعديل
- إضافة حالات جديدة:
  - `isEditMode`: لتحديد ما إذا كانت الصفحة في وضع التعديل
  - `editingInvoiceId`: لحفظ معرف الفاتورة قيد التعديل
  - `invoiceNumberParam`: لاستخراج رقم الفاتورة من URL

### 2. دالة تحميل الفاتورة للتعديل
- `loadInvoiceForEdit()`: دالة تقوم بجلب بيانات الفاتورة من قاعدة البيانات
- تملأ جميع حقول الفاتورة والأصناف
- تعرض رسالة نجاح أو خطأ
- إعادة توجيه تلقائي في حالة عدم العثور على الفاتورة

### 3. تحديث دالة الحفظ
- تم تعديل `handleSave()` للتعامل مع الحالتين:
  - **الإنشاء**: إنشاء فاتورة جديدة (السلوك السابق)
  - **التحديث**: تحديث فاتورة موجودة باستخدام `updateDoc`
- في وضع التعديل: العودة التلقائية إلى صفحة التقارير بعد التحديث
- في وضع الإنشاء: إعادة تعيين النموذج للفاتورة التالية

### 4. تحديث واجهة المستخدم
- **العنوان**: يتغير بين "فاتورة مبيعات جديدة" و "تعديل فاتورة مبيعات رقم X"
- **الأيقونة**: تتغير بين FileText (إنشاء) و EditOutlined (تعديل)
- **اللون**: تدرج أزرق للإنشاء، تدرج برتقالي للتعديل
- **الـ Breadcrumb**: يتضمن رابط للعودة إلى صفحة التقارير
- **زر الحفظ**: "حفظ الفاتورة" أو "تحديث الفاتورة"
- **زر الإلغاء**: يظهر فقط في وضع التعديل للعودة إلى التقارير

### 6. تحديث الروابط لفتح في صفحة جديدة
- تم إضافة `target="_blank"` و `rel="noopener noreferrer"` للرابط
- عند النقر على رقم الفاتورة، ستفتح صفحة التعديل في تبويب جديد
- يمكن للمستخدم العمل على صفحة التقارير وصفحة التعديل في نفس الوقت

### 7. تحديث ملف Index.tsx
- تم تصحيح استيراد الصفحة من `EditSalesInvoice` إلى `EditSalesInvoicePage`
- تم تأكيد تسجيل الروت بشكل صحيح: `/stores/edit-sales-invoice`

## كيفية الاستخدام

### إنشاء فاتورة جديدة
1. زيارة الصفحة مباشرة: `/stores/edit-sales-invoice`
2. ملء البيانات والأصناف
3. النقر على "حفظ الفاتورة"

### تعديل فاتورة موجودة
1. الانتقال إلى صفحة التقارير: `/management/sales/reports/invoice`
2. البحث عن الفاتورة المطلوبة
3. النقر على رقم الفاتورة (سيفتح في تبويب جديد)
4. سيتم فتح صفحة التعديل بوضع التعديل مع تعبئة جميع البيانات
5. إجراء التعديلات المطلوبة
6. النقر على "تحديث الفاتورة" أو "إلغاء" للعودة

**ملاحظة**: فتح صفحة التعديل في تبويب جديد يسمح بالعمل على التقارير والتعديل في نفس الوقت.

## الملفات المُحدثة

### `/src/pages/stores/EditSalesInvoicePage.tsx`
- إضافة استيرادات `useSearchParams`, `useNavigate`, `updateDoc`
- إضافة حالات جديدة لوضع التعديل
- دالة `loadInvoiceForEdit()`
- تحديث `handleSave()` للتعامل مع التحديث
- تحديث واجهة المستخدم حسب الوضع

### `/src/pages/reports/invoice.tsx`
- تحديث رابط رقم الفاتورة لتوجيه المستخدم إلى صفحة التعديل الجديدة
- إضافة `target="_blank"` لفتح الرابط في تبويب جديد

### `/src/pages/Index.tsx`
- تصحيح استيراد `EditSalesInvoicePage`
- تأكيد تسجيل الروت بشكل صحيح

## المميزات الإضافية

1. **فتح في تبويب جديد**: الروابط تفتح في تبويبات منفصلة لتحسين تجربة المستخدم
2. **التحقق من صحة البيانات**: نفس عمليات التحقق في كلا الوضعين
3. **إدارة الأخطاء**: معالجة مناسبة للأخطاء مع رسائل واضحة
4. **تحديث الأرصدة**: يتم تحديث أرصدة المخازن بعد التحديث كما في الإنشاء
5. **تجربة مستخدم محسنة**: واجهة واضحة تُعبر عن الوضع الحالي

## ملاحظات تقنية

- استخدام `useCallback` لتحسين الأداء
- Type safety مع TypeScript
- معالجة صحيحة لحالات الخطأ
- إدارة حالة مناسبة للتطبيق
